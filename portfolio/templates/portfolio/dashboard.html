{% extends 'portfolio/base.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-header-card">
    <h1>Welcome, {{ user.username }}</h1>
    <p>Your Portfolio Overview</p>
</div>

<!-- Action Buttons -->
<div class="dashboard-actions">
    <a href="{% url 'portfolio:add_holding' %}" class="btn-action">‚ûï Add Holding</a>
    <a href="{% url 'portfolio:export_excel' %}" class="btn-action">üìä Export Excel</a>
    <form method="post" action="{% url 'portfolio:logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn-action logout">üö™ Logout</button>
    </form>
</div>

<!-- Stats Cards -->
<div class="cards-container">
    <div class="card">
        <h3>Total Investment</h3>
        <p class="value">${{ total_investment|floatformat:2 }}</p>
    </div>
    <div class="card">
        <h3>Current Value</h3>
        <p class="value">${{ total_value|floatformat:2 }}</p>
    </div>
    <div class="card">
        <h3>Total Profit / Loss</h3>
        <p class="value {% if total_profit >= 0 %}profit{% else %}loss{% endif %}">
            ${{ total_profit|floatformat:2 }}
        </p>
    </div>
</div>

<!-- Portfolio Pie Chart -->
<div class="card chart-card">
    <h3>üìà Portfolio Trend</h3>
    <canvas id="portfolioChart" class="responsive-chart"></canvas>
</div>

<!-- Holdings Table -->
<div class="holdings-section">
    <h2>üìå My Holdings</h2>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Stock</th>
                    <th>Quantity</th>
                    <th>Buy Price</th>
                    <th>Current Price</th>
                    <th>Profit/Loss</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for h in holdings %}
                <tr>
                    <td>{{ h.stock_symbol }}</td>
                    <td>{{ h.quantity }}</td>
                    <td>${{ h.purchase_price|floatformat:2 }}</td>
                    <td>${{ h.current_price|floatformat:2 }}</td>
                    <td class="{% if h.is_profit %}profit{% else %}loss{% endif %}">
                        ${{ h.profit_loss|floatformat:2 }}
                    </td>
                    <td>
                        <a href="{% url 'portfolio:edit_holding' h.id %}" class="action-link">‚úèÔ∏è Edit</a> |
                        <form action="{% url 'portfolio:delete_holding' h.id %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="action-link delete" onclick="return confirm('Are you sure you want to delete this holding?');">
                                üóëÔ∏è Delete
                            </button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6">No holdings yet. Add your first investment!</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ===== Add Chart.js ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Build data from Django context
    const labels = [{% for h in holdings %}'{{ h.stock_symbol }}'{% if not forloop.last %},{% endif %}{% endfor %}];
    const values = [{% for h in holdings %}{{ h.current_price|floatformat:2 }}{% if not forloop.last %},{% endif %}{% endfor %}];

    // Choose legend color based on current theme
    const isDark = document.documentElement.getAttribute("data-theme") === "dark";
    const legendColor = isDark ? "#ffffff" : "#000000";

    new Chart(document.getElementById('portfolioChart'), {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc948']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: legendColor }
                }
            }
        }
    });
});
</script>
{% endblock %}

















